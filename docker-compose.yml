services:
  # Note: Ollama runs natively on the Docker host (not in a container)
  # Ollama must be installed and running on the host, listening on 0.0.0.0:11434
  # Services access Ollama via host.docker.internal:11434

  # Code-Server Init - Fix volume permissions
  code-server-init:
    image: alpine:latest
    container_name: code-buddy-code-server-init
    volumes:
      - code-buddy-code-server-data:/data
      - code-buddy-code-server-config:/config
      - code-buddy-code-server-extensions:/extensions
      - code-buddy-code-server-logs:/logs
    command: |
      sh -c "
      chown -R 1000:1000 /data /config /extensions /logs 2>/dev/null || true &&
      chmod -R 755 /data /config /extensions /logs 2>/dev/null || true
      "
    networks:
      - code-buddy-network
    restart: "no"

  # Code-Server - Web-based VS Code IDE
  code-server:
    image: codercom/code-server:latest
    container_name: code-buddy-code-server
    volumes:
      - code-buddy-code-server-data:/home/coder
      - code-buddy-code-server-config:/home/coder/.config
      - code-buddy-code-server-extensions:/home/coder/.local/share/code-server/extensions
      - code-buddy-code-server-logs:/home/coder/.local/share/code-server/logs
      - ./workspace:/home/coder/workspace
    environment:
      - PASSWORD=${CODE_SERVER_PASSWORD:-codebuddy123}
      - SUDO_PASSWORD=${CODE_SERVER_PASSWORD:-codebuddy123}
      - DEFAULT_WORKSPACE=/home/coder/workspace
    # Expose Code-Server on all host IP addresses via configurable port
    # Accessible via: http://<host-ip>:${CODE_SERVER_PORT}
    # Also accessible via Nginx on port 80: http://<host-ip>
    ports:
      - "0.0.0.0:${CODE_SERVER_PORT:-8080}:8080"
    restart: unless-stopped
    networks:
      - code-buddy-network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      code-server-init:
        condition: service_completed_successfully
    command: ["--bind-addr", "0.0.0.0:8080"]

  # Agent Orchestrator - Main AI Agent Service
  agent-orchestrator:
    build:
      context: ./services/agent-orchestrator
      dockerfile: Dockerfile
    container_name: code-buddy-agent-orchestrator
    volumes:
      - ./workspace:/app/workspace
      - code-buddy-agent-data:/app/data
      - code-buddy-agent-cache:/app/.cache
      - code-buddy-agent-logs:/app/logs
      - code-buddy-agent-state:/app/state
    environment:
      - OLLAMA_HOST=${OLLAMA_HOST:-http://host.docker.internal:11434}
      - WORKSPACE_PATH=/app/workspace
      - LOG_LEVEL=INFO
      - DATA_DIR=/app/data
      - CACHE_DIR=/app/.cache
      - LOG_DIR=/app/logs
      - STATE_DIR=/app/state
    # No external port - accessed via API Gateway on internal network
    expose:
      - "8000"
    restart: unless-stopped
    networks:
      - code-buddy-network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      - mcp-github
      - mcp-gitlab
      - qdrant

  # MCP GitHub Server
  mcp-github:
    build:
      context: ./services/mcp-github
      dockerfile: Dockerfile
    container_name: code-buddy-mcp-github
    volumes:
      - code-buddy-mcp-github-data:/app/data
      - code-buddy-mcp-github-cache:/app/.cache
      - code-buddy-mcp-github-logs:/app/logs
      - code-buddy-mcp-github-node_modules:/app/node_modules
    environment:
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}
      - MCP_PORT=3001
      - DATA_DIR=/app/data
      - CACHE_DIR=/app/.cache
      - LOG_DIR=/app/logs
    # No external port - accessed via API Gateway on internal network
    expose:
      - "3001"
    restart: unless-stopped
    networks:
      - code-buddy-network

  # MCP GitLab Server
  mcp-gitlab:
    build:
      context: ./services/mcp-gitlab
      dockerfile: Dockerfile
    container_name: code-buddy-mcp-gitlab
    volumes:
      - code-buddy-mcp-gitlab-data:/app/data
      - code-buddy-mcp-gitlab-cache:/app/.cache
      - code-buddy-mcp-gitlab-logs:/app/logs
      - code-buddy-mcp-gitlab-node_modules:/app/node_modules
    environment:
      - GITLAB_TOKEN=${GITLAB_TOKEN:-}
      - GITLAB_URL=${GITLAB_URL:-https://gitlab.com}
      - MCP_PORT=3002
      - DATA_DIR=/app/data
      - CACHE_DIR=/app/.cache
      - LOG_DIR=/app/logs
    # No external port - accessed via API Gateway on internal network
    expose:
      - "3002"
    restart: unless-stopped
    networks:
      - code-buddy-network

  # Qdrant - Vector Database for Code Indexing and RAG
  qdrant:
    image: qdrant/qdrant:latest
    container_name: code-buddy-qdrant
    volumes:
      - code-buddy-qdrant-data:/qdrant/storage
      - code-buddy-qdrant-config:/qdrant/config
      - code-buddy-qdrant-logs:/qdrant/logs
    # No external ports - accessed only on internal network
    expose:
      - "6333"  # HTTP
      - "6334"  # gRPC
    restart: unless-stopped
    networks:
      - code-buddy-network

  # Code Indexer - Indexes codebase into Qdrant
  code-indexer:
    build:
      context: ./services/code-indexer
      dockerfile: Dockerfile
    container_name: code-buddy-code-indexer
    volumes:
      - ./workspace:/app/workspace
      - code-buddy-indexer-data:/app/data
      - code-buddy-indexer-cache:/app/.cache
      - code-buddy-indexer-logs:/app/logs
      - code-buddy-indexer-state:/app/state
    environment:
      - QDRANT_HOST=http://qdrant:6333
      - OLLAMA_HOST=${OLLAMA_HOST:-http://host.docker.internal:11434}
      - WORKSPACE_PATH=/app/workspace
      - LOG_LEVEL=INFO
      - DATA_DIR=/app/data
      - CACHE_DIR=/app/.cache
      - LOG_DIR=/app/logs
      - STATE_DIR=/app/state
    # No external port - accessed via API Gateway on internal network
    expose:
      - "8002"
    restart: unless-stopped
    networks:
      - code-buddy-network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      - qdrant

  # RAG Chat Service - Codebase-aware chat with RAG
  rag-chat:
    build:
      context: ./services/rag-chat
      dockerfile: Dockerfile
    container_name: code-buddy-rag-chat
    volumes:
      - ./workspace:/app/workspace
      - code-buddy-rag-chat-data:/app/data
      - code-buddy-rag-chat-cache:/app/.cache
      - code-buddy-rag-chat-logs:/app/logs
    environment:
      - QDRANT_HOST=http://qdrant:6333
      - OLLAMA_HOST=${OLLAMA_HOST:-http://host.docker.internal:11434}
      - WORKSPACE_PATH=/app/workspace
      - LOG_LEVEL=INFO
      - DATA_DIR=/app/data
      - CACHE_DIR=/app/.cache
      - LOG_DIR=/app/logs
    # No external port - accessed via API Gateway on internal network
    expose:
      - "8003"
    restart: unless-stopped
    networks:
      - code-buddy-network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      - qdrant
      - code-indexer

  # VS Code Extension Server - IDE Integration
  vscode-extension-server:
    build:
      context: ./services/vscode-extension-server
      dockerfile: Dockerfile
    container_name: code-buddy-vscode-extension
    volumes:
      - code-buddy-vscode-extension-data:/app/data
      - code-buddy-vscode-extension-logs:/app/logs
    environment:
      - OLLAMA_HOST=${OLLAMA_HOST:-http://host.docker.internal:11434}
      - AGENT_ORCHESTRATOR_URL=http://agent-orchestrator:8000
      - RAG_CHAT_URL=http://rag-chat:8003
      - PORT=3003
    # No external ports - accessed via API Gateway on internal network
    expose:
      - "3003"  # HTTP
      - "3004"  # WebSocket
    restart: unless-stopped
    networks:
      - code-buddy-network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      - agent-orchestrator
      - rag-chat

  # Terminal AI Assistant
  terminal-ai:
    build:
      context: ./services/terminal-ai
      dockerfile: Dockerfile
    container_name: code-buddy-terminal-ai
    volumes:
      - code-buddy-terminal-ai-data:/app/data
      - code-buddy-terminal-ai-cache:/app/.cache
      - code-buddy-terminal-ai-logs:/app/logs
    environment:
      - OLLAMA_HOST=${OLLAMA_HOST:-http://host.docker.internal:11434}
      - AGENT_ORCHESTRATOR_URL=http://agent-orchestrator:8000
      - DATA_DIR=/app/data
      - CACHE_DIR=/app/.cache
      - LOG_DIR=/app/logs
    # No external port - accessed via API Gateway on internal network
    expose:
      - "8004"
    restart: unless-stopped
    networks:
      - code-buddy-network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      - agent-orchestrator

  # Rules Engine - Coding Standards Enforcement
  rules-engine:
    build:
      context: ./services/rules-engine
      dockerfile: Dockerfile
    container_name: code-buddy-rules-engine
    volumes:
      - ./rules:/app/rules:ro
      - code-buddy-rules-data:/app/data
      - code-buddy-rules-cache:/app/.cache
      - code-buddy-rules-logs:/app/logs
    environment:
      - RULES_PATH=/app/rules
      - LOG_LEVEL=INFO
      - DATA_DIR=/app/data
      - CACHE_DIR=/app/.cache
      - LOG_DIR=/app/logs
    # No external port - accessed via API Gateway on internal network
    expose:
      - "8001"
    restart: unless-stopped
    networks:
      - code-buddy-network

  # API Gateway - Unified API Interface
  api-gateway:
    build:
      context: ./services/api-gateway
      dockerfile: Dockerfile
    container_name: code-buddy-api-gateway
    volumes:
      - code-buddy-api-gateway-data:/app/data
      - code-buddy-api-gateway-cache:/app/.cache
      - code-buddy-api-gateway-logs:/app/logs
    environment:
      - AGENT_ORCHESTRATOR_URL=http://agent-orchestrator:8000
      - RULES_ENGINE_URL=http://rules-engine:8001
      - MCP_GITHUB_URL=http://mcp-github:3001
      - MCP_GITLAB_URL=http://mcp-gitlab:3002
      - OLLAMA_URL=${OLLAMA_URL:-http://host.docker.internal:11434}
      - QDRANT_URL=http://qdrant:6333
      - CODE_INDEXER_URL=http://code-indexer:8002
      - RAG_CHAT_URL=http://rag-chat:8003
      - VSCODE_EXTENSION_URL=http://vscode-extension-server:3003
      - TERMINAL_AI_URL=http://terminal-ai:8004
      - DATA_DIR=/app/data
      - CACHE_DIR=/app/.cache
      - LOG_DIR=/app/logs
    # No external port - accessed via Nginx on internal network
    expose:
      - "9000"
    restart: unless-stopped
    networks:
      - code-buddy-network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      - agent-orchestrator
      - rules-engine
      - mcp-github
      - mcp-gitlab
      - qdrant
      - code-indexer
      - rag-chat
      - vscode-extension-server
      - terminal-ai

  # Nginx Reverse Proxy
  nginx:
    image: nginx:alpine
    container_name: code-buddy-nginx
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - code-buddy-nginx-logs:/var/log/nginx
      - code-buddy-nginx-cache:/var/cache/nginx
    ports:
      - "80:80"
      - "443:443"
    restart: unless-stopped
    networks:
      - code-buddy-network
    depends_on:
      code-server:
        condition: service_started
      api-gateway:
        condition: service_started

volumes:
  # Code-Server
  code-buddy-code-server-data:
  code-buddy-code-server-config:
  code-buddy-code-server-extensions:
  code-buddy-code-server-logs:
  
  # Agent Orchestrator
  code-buddy-agent-data:
  code-buddy-agent-cache:
  code-buddy-agent-logs:
  code-buddy-agent-state:
  
  # MCP GitHub
  code-buddy-mcp-github-data:
  code-buddy-mcp-github-cache:
  code-buddy-mcp-github-logs:
  code-buddy-mcp-github-node_modules:
  
  # MCP GitLab
  code-buddy-mcp-gitlab-data:
  code-buddy-mcp-gitlab-cache:
  code-buddy-mcp-gitlab-logs:
  code-buddy-mcp-gitlab-node_modules:
  
  # Qdrant
  code-buddy-qdrant-data:
  code-buddy-qdrant-config:
  code-buddy-qdrant-logs:
  
  # Code Indexer
  code-buddy-indexer-data:
  code-buddy-indexer-cache:
  code-buddy-indexer-logs:
  code-buddy-indexer-state:
  
  # RAG Chat
  code-buddy-rag-chat-data:
  code-buddy-rag-chat-cache:
  code-buddy-rag-chat-logs:
  
  # Rules Engine
  code-buddy-rules-data:
  code-buddy-rules-cache:
  code-buddy-rules-logs:
  
  # API Gateway
  code-buddy-api-gateway-data:
  code-buddy-api-gateway-cache:
  code-buddy-api-gateway-logs:
  
  # Nginx
  code-buddy-nginx-logs:
  code-buddy-nginx-cache:
  
  # VS Code Extension Server
  code-buddy-vscode-extension-data:
  code-buddy-vscode-extension-logs:
  
  # Terminal AI
  code-buddy-terminal-ai-data:
  code-buddy-terminal-ai-cache:
  code-buddy-terminal-ai-logs:

networks:
  code-buddy-network:
    driver: bridge

